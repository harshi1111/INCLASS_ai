{% extends "base.html" %}
{% block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-6 text-center">
      <div class="card shadow-lg border-0">
        <div class="card-body py-5">
          <div class="loading-spinner mb-4">
            <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
          <h4 class="card-title fw-bold text-primary">Processing Attendance</h4>
          <p class="card-text text-muted">Please wait while we analyze the image and identify students...</p>

          <div class="progress mt-4" style="height: 10px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
          </div>

          <div class="mt-3">
            <small class="text-muted">This may take a few seconds depending on image size and number of students.</small>
          </div>

          <div class="mt-4">
            <div class="processing-steps">
              <div class="step active">
                <i class="bi bi-check-circle-fill text-success"></i>
                <span>Image Uploaded</span>
              </div>
              <div class="step active">
                <i class="bi bi-arrow-repeat text-primary"></i>
                <span>Analyzing Faces</span>
              </div>
              <div class="step">
                <i class="bi bi-people"></i>
                <span>Identifying Students</span>
              </div>
              <div class="step">
                <i class="bi bi-check-lg"></i>
                <span>Complete</span>
              </div>
            </div>
          </div>

        </div> <!-- card-body -->
      </div> <!-- card -->
    </div>
  </div>
</div>

<script>
(function poll() {
  fetch("{{ url_for('check_attendance_result', task_id=task_id) }}", { redirect: 'follow' })
    .then(async (resp) => {
      // If server rendered the result (200 OK HTML), replace document
      const text = await resp.text();
      if (text.includes('attendance_result') || !text.includes('processing')) {
        document.open(); document.write(text); document.close();
      } else {
        setTimeout(poll, 1500);
      }
    })
    .catch(() => setTimeout(poll, 2000));
})();
</script>
{% endblock %}
